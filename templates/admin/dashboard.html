<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {background: linear-gradient(135deg, #f2f2f5 0%, #e2d6c6 100%);}
        .address-text {
            font-size: 0.9em;
            line-height: 1.4;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .admin-layout {min-height:100vh;}
        .admin-sidebar {
            width:240px;
            background:#ffffff;
            color:#111111;
            border-right:1px solid #e1e1e1;
            padding:20px 16px;
        }
        .admin-sidebar .brand {
            font-weight:700;
            font-size:18px;
            letter-spacing:.12em;
            text-transform:uppercase;
            margin-bottom:24px;
        }
        .admin-sidebar .nav-link {
            color:#555555;
            padding:8px 12px;
            border-radius:6px;
            font-size:14px;
        }
        .admin-sidebar .nav-link.active,
        .admin-sidebar .nav-link:hover {
            background:#f0efeb;
            color:#111111;
        }
        .admin-content {padding:24px;}
    </style>
</head>
<body>
    <div class="admin-layout d-flex">
        <nav class="admin-sidebar d-flex flex-column">
            <div class="brand mb-3">ADMIN</div>
            <ul class="nav flex-column mb-4">
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if admin_active == 'dashboard' else '' }}" href="{{ url_for('admin') }}">
                        <i class="bi bi-speedometer2 me-2"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if admin_active == 'users' else '' }}" href="{{ url_for('admin_users') }}">
                        <i class="bi bi-people me-2"></i>Users
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if admin_active == 'products' else '' }}" href="{{ url_for('admin_products') }}">
                        <i class="bi bi-box-seam me-2"></i>Products
                    </a>
                </li>
            </ul>
            <div class="mt-auto small text-muted">
                <a href="{{ url_for('landing') }}" class="nav-link px-0">&larr; Back to site</a>
            </div>
        </nav>
        <main class="admin-content flex-grow-1">
        <h2 class="mb-4">Admin Dashboard</h2>

        {% set stats = admin_stats or {} %}
        {% set roles = stats.users_by_role or {} %}

        <!-- Metrics row -->
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Total Users</span>
                            <i class="bi bi-people fs-4 text-primary"></i>
                        </div>
                        <h3 class="mb-1">{{ stats.total_users }}</h3>
                        <div class="text-muted small">
                            B {{ roles.buyer }} · S {{ roles.seller }} · R {{ roles.rider }} · A {{ roles.admin }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Products</span>
                            <i class="bi bi-box-seam fs-4 text-success"></i>
                        </div>
                        <h3 class="mb-1">{{ stats.active_products }}</h3>
                        <div class="text-muted small">Active of {{ stats.total_products }} total</div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Orders (Last 7 days)</span>
                            <i class="bi bi-receipt fs-4 text-warning"></i>
                        </div>
                        <h3 class="mb-1">{{ stats.orders_last_7 }}</h3>
                        <div class="text-muted small">Total orders: {{ stats.total_orders }}</div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Revenue (Last 7 days)</span>
                            <i class="bi bi-currency-dollar fs-4 text-danger"></i>
                        </div>
                        <h3 class="mb-1">₱{{ '%.2f'|format(stats.revenue_last_7) }}</h3>
                        <div class="text-muted small">All-time: ₱{{ '%.2f'|format(stats.total_revenue) }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Critical items row -->
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-4">
                <a href="{{ url_for('admin_users', status='pending') }}" class="text-decoration-none text-reset">
                    <div class="card shadow-sm h-100 border-start border-4 border-warning">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted small">Pending Users</span>
                                <i class="bi bi-person-check fs-4 text-warning"></i>
                            </div>
                            <h3 class="mb-1">{{ stats.pending_users_count }}</h3>
                            <div class="text-muted small">Review new registrations</div>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-12 col-md-4">
                <a href="{{ url_for('admin_products') }}" class="text-decoration-none text-reset">
                    <div class="card shadow-sm h-100 border-start border-4 border-danger">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted small">Pending Orders</span>
                                <i class="bi bi-hourglass-split fs-4 text-danger"></i>
                            </div>
                            <h3 class="mb-1">{{ stats.pending_orders_count or 0 }}</h3>
                            <div class="text-muted small">Orders awaiting processing</div>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-12 col-md-4">
                <a href="{{ url_for('admin_products', status='active') }}" class="text-decoration-none text-reset">
                    <div class="card shadow-sm h-100 border-start border-4 border-primary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted small">Low-Stock Products</span>
                                <i class="bi bi-exclamation-triangle fs-4 text-primary"></i>
                            </div>
                            <h3 class="mb-1">{{ stats.low_stock_count or 0 }}</h3>
                            <div class="text-muted small">Stock ≤ 5 (active)</div>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Orders overview & quick links -->
        <div class="row g-3 mb-4">
            <div class="col-12 col-lg-8">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Orders by Status</span>
                        </div>
                        <div class="row text-center">
                            <div class="col-6 col-md-3 mb-2">
                                <div class="text-muted small">Pending</div>
                                <div class="fs-5 fw-semibold">{{ stats.order_status_counts.pending }}</div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="text-muted small">Processing</div>
                                <div class="fs-5 fw-semibold">{{ stats.order_status_counts.processing }}</div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="text-muted small">Completed</div>
                                <div class="fs-5 fw-semibold">{{ stats.order_status_counts.completed }}</div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="text-muted small">Cancelled</div>
                                <div class="fs-5 fw-semibold">{{ stats.order_status_counts.cancelled }}</div>
                            </div>
                        </div>
                        <hr>
                        <h6 class="text-muted">Daily Orders (Last 30 days)</h6>
                        {% if stats.daily_order_labels %}
                            <canvas id="ordersChart" height="120"></canvas>
                        {% else %}
                            <div class="text-muted small">No orders recorded in the last 30 days.</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="text-muted mb-3">Quick Links</h6>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <a href="{{ url_for('admin_users', status='pending') }}" class="text-decoration-none">
                                    <i class="bi bi-chevron-right"></i> Review pending users
                                </a>
                            </li>
                            <li class="mb-2">
                                <a href="{{ url_for('admin_products', status='active') }}" class="text-decoration-none">
                                    <i class="bi bi-chevron-right"></i> View low-stock products
                                </a>
                            </li>
                            <li class="mb-2">
                                <a href="#high-value-orders" class="text-decoration-none">
                                    <i class="bi bi-chevron-right"></i> View recent high-value orders
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <h4 class="mt-4" id="high-value-orders">Pending User Applications</h4>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Recent high-value orders -->
        <h4 class="mt-4" id="high-value-orders">Recent High-Value Orders</h4>
        {% if recent_high_value_orders %}
            <div class="table-responsive mt-2 mb-4">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Order #</th>
                            <th>Buyer</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for o in recent_high_value_orders %}
                        <tr>
                            <td>{{ o.order_number }}</td>
                            <td>{{ o.buyer_first_name }} {{ o.buyer_last_name }}</td>
                            <td>₱{{ '%.2f'|format(o.total_price) }}</td>
                            <td><span class="badge bg-secondary text-uppercase">{{ o.status }}</span></td>
                            <td>{{ o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info mt-2 mb-4">
                <i class="bi bi-info-circle"></i> No recent high-value orders.
            </div>
        {% endif %}

        <h4 class="mt-4">Pending User Applications</h4>

        {% if pending_users %}
            <div class="alert alert-info">
                <strong>{{ pending_users|length }}</strong> pending application(s)
            </div>

            <div class="table-responsive mt-4">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Account Type</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>Valid ID</th>
                            <th>Google User</th>
                            <th>Date Applied</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in pending_users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.first_name }} {{ user.last_name }}</td>
                            <td>{{ user.email }}</td>
                            <td><span class="badge bg-info">{{ user.account_type|title }}</span></td>
                            <td>{{ user.phone }}</td>
                            <td>
                                <div class="address-text">
                                    {% if user.street %}
                                        <strong>{{ user.street }}</strong><br>
                                    {% endif %}
                                    {{ user.barangay_name }}<br>
                                    {{ user.municipality_name }}<br>
                                    {{ user.province_name }}<br>
                                    {{ user.region_name }}
                                    {% if user.zip_code %}
                                        <br>{{ user.zip_code }}
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if user.valid_id %}
                                    <a href="{{ url_for('static', filename='../uploads/' + user.valid_id) }}" 
                                       target="_blank" 
                                       class="btn btn-sm btn-outline-primary">
                                        View ID
                                    </a>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.is_google_user %}
                                    <span class="badge bg-success">Yes</span>
                                {% else %}
                                    <span class="badge bg-secondary">No</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.created_at %}
                                    {{ user.created_at.strftime('%Y-%m-%d') }}<br>
                                    <small class="text-muted">{{ user.created_at.strftime('%H:%M') }}</small>
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group-vertical" role="group">
                                    <a href="{{ url_for('approve_user', user_id=user.id) }}" 
                                       class="btn btn-sm btn-success mb-1" 
                                       onclick="return confirm('Approve this user?')">
                                        ✓ Approve
                                    </a>
                                    <a href="{{ url_for('reject_user', user_id=user.id) }}" 
                                       class="btn btn-sm btn-danger" 
                                       onclick="return confirm('Reject this user?')">
                                        ✗ Reject
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info mt-4">
                <i class="bi bi-info-circle"></i> No pending applications at the moment.
            </div>
        {% endif %}
    </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const labels = {{ stats.daily_order_labels|tojson|safe }};
            const data = {{ stats.daily_order_counts|tojson|safe }};
            if (labels && labels.length && document.getElementById('ordersChart')) {
                const ctx = document.getElementById('ordersChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Orders',
                            data: data,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 3,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                        },
                        scales: {
                            x: { display: true },
                            y: { beginAtZero: true, ticks: { precision: 0 } },
                        },
                    }
                });
            }
        });
    </script>
</body>
</html>
